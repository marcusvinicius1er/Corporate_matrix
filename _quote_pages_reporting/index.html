<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OXO Corporate Reporting – Pricing Matrix (Pages)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;
      --ink:#0b1824;
      --muted:#6f7b86;
      --line:#e3ebf0;
      --soft:#f6f9fb;
      --soft2:#eef4f7;
      --petrol:#0f4c5c;
      --petrol-dark:#09323d;
      --magenta:#d33fa0;
      --gold:#c6a25a;
    }
    *,*:before,*:after{box-sizing:border-box}
    body{margin:0;background:var(--soft);color:var(--ink);font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    .page{max-width:1180px;margin:40px auto 64px;padding:0 24px}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:16px;margin-bottom:24px}
    header img{height:60px;object-fit:contain;margin:auto 0}
    .hero{flex:1 1 260px;background:linear-gradient(135deg,rgba(15,76,92,.96),#082733);color:#fff;padding:16px 22px;border-radius:16px;box-shadow:0 12px 28px rgba(9,46,57,.22)}
    .hero h1{margin:0 0 6px;font:700 19px/1.25 Montserrat,sans-serif}
    .hero p{margin:0;font-size:13px;opacity:.82}
    .workspace{background:#fff;border-radius:20px;border:1px solid var(--line);box-shadow:0 30px 60px rgba(9,46,57,.08);padding:28px}
    .toolbar{display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;padding:14px 16px;border-radius:16px;background:linear-gradient(135deg,rgba(241,247,249,0.95),rgba(227,235,240,0.92));border:1px solid rgba(15,76,92,0.2)}
    .controls label{font:700 12px/1 Montserrat;text-transform:uppercase;color:var(--petrol-dark);letter-spacing:.5px}
    .controls input[type=number],.controls select{width:180px;padding:12px 14px;font:600 15px/1.1 Inter;border-radius:12px;border:1.5px solid var(--line);background:#fff;box-shadow:inset 0 1px 2px rgba(15,76,92,.05)}
    .controls.is-missing input[type=number]{border-color:#d33f3f;background:#fff5f5}
    .controls.is-missing label{color:#d33f3f}
    .hint{font-size:12px;color:var(--muted)}
    .hint.required{color:#d33f3f;font-weight:600}
    .hint.required.hidden{display:none}
    .btn{appearance:none;border-radius:12px;padding:11px 18px;font:700 13px/1 Montserrat;border:1px solid var(--petrol);color:var(--petrol);background:#fff;cursor:pointer;transition:all .2s ease}
    .btn:hover{background:var(--petrol);color:#fff}
    .btn:disabled{opacity:.45;cursor:not-allowed;background:#dbe4e9;color:#7f8b94;border-color:#dbe4e9}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;vertical-align:top;border-bottom:1px solid var(--line)}
    th{text-align:left;font:600 11px/1.2 Montserrat;letter-spacing:.45px;color:#4a5e6a;text-transform:uppercase}
    td{font-size:14px;color:var(--ink)}
    .section-label{font:600 15px/1.3 Montserrat;margin-bottom:4px;color:var(--petrol-dark)}
    .section-note{font-size:12px;line-height:1.5;color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .right{text-align:right}
    .stripe td{background:var(--soft2);font:700 14px/1 Montserrat}
    .summary-row td{
      background:linear-gradient(135deg,rgba(44,140,108,0.96),rgba(24,98,80,0.92));
      color:#ffffff;
      font:700 15px/1.2 Montserrat;
      text-transform:uppercase;
      border:0;
      box-shadow:inset 0 0 0 2px rgba(22,108,85,0.65);
    }
    .summary-row td:first-child{border-radius:12px 0 0 12px;padding-left:16px}
    .summary-row td:last-child{border-radius:0 12px 12px 0}
    .opt-row td{background:#fbf7ff}
    .opt-row--active td{background:#eef6f8}
    .opt-flag{display:inline-block;margin-left:8px;font:700 10px/1 Montserrat;letter-spacing:.6px;color:var(--magenta)}
    .opt-row--active .opt-flag{color:var(--petrol)}
    .row-invalid td{background:#fff5f5 !important;border-color:#d33f3f !important}
    .row-invalid td .mono,.row-invalid td input[type=number]{color:#d33f3f;font-weight:700;border-color:#d33f3f !important}
    .highlight-magenta{display:inline-block;padding:0 6px;border-radius:6px;background:rgba(211,63,160,.16);color:var(--magenta);font-weight:700}
    .title-deliverable{display:block;margin-top:4px;font:600 11px/1.3 Montserrat;letter-spacing:.3px;color:var(--petrol-dark);text-transform:uppercase}
    .center{text-align:center}
    .include-cell{text-align:center}
    .include-toggle{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--petrol-dark)}
    .include-toggle input{accent-color:var(--petrol)}
    .include-toggle span{white-space:nowrap}
    .include-toggle-arabic{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--petrol-dark);padding:4px 8px;border-radius:8px;border:2px solid #22c55e;background:rgba(34,197,94,0.08)}
    .include-toggle-arabic input{accent-color:#22c55e}
    .include-toggle-arabic span{white-space:nowrap}
    .tag-included{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(15,76,92,.12);font:600 12px/1 Inter;color:var(--petrol)}
    .opt-quantity{font-weight:600;color:var(--petrol-dark)}
    .totals-grid{margin:26px 0 18px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{padding:18px;border-radius:16px;border:1px solid rgba(15,76,92,.12);background:linear-gradient(145deg,rgba(246,249,251,.96),rgba(255,255,255,.9))}
    .card-heading{font:600 12px/1 Montserrat;text-transform:uppercase;letter-spacing:.45px;color:#3a4a52;margin-bottom:6px}
    .card strong{display:block;font:700 22px/1.1 Montserrat;color:var(--petrol)}
    .card small{display:block;margin-top:6px;font-size:12px;color:var(--muted)}
    .grand{background:linear-gradient(135deg,rgba(211,63,160,.12),rgba(15,76,92,.08));border:1px solid rgba(211,63,160,.26)}
    .grand strong{color:var(--magenta)}
    .link-list{margin:8px 0 0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:8px}
    .link-list li{margin:0}
    .link-list a{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:rgba(15,76,92,.08);color:var(--petrol);font:600 12px/1 Montserrat;text-decoration:none;transition:all .2s ease}
    .link-list a:hover{background:rgba(15,76,92,.16);color:var(--petrol-dark)}
    .no-print{display:flex}
    @media print{
      @page{
        margin:16mm 14mm 18mm;
      }
      body{
        background:#ffffff;
        color:#0b1824;
        font-family:Inter,"Helvetica Neue",Arial,sans-serif;
        font-size:13px;
      }
      .page{
        max-width:none;
        margin:0;
        padding:0;
      }
      header{
        margin-bottom:18px;
        align-items:flex-start;
      }
      header img{
        height:48px;
      }
      .hero{
        background:linear-gradient(135deg,rgba(15,76,92,.12),rgba(8,39,51,.08));
        color:#0b1824;
        border:1px solid rgba(15,76,92,.2);
        box-shadow:none;
      }
      .hero h1{
        font-size:20px;
        margin-bottom:8px;
      }
      .hero p{
        font-size:12px;
        opacity:.85;
      }
      .workspace{
        box-shadow:none;
        border:0;
        padding:0;
      }
      .no-print{display:none !important}
      .totals-grid{
        grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
        gap:12px;
        margin:0 0 16px;
      }
      .card{
        border:1px solid rgba(15,76,92,.22);
        background:#f5f8fa;
        break-inside:avoid;
        padding:16px;
      }
      .card strong{
        font-size:20px;
      }
      table{
        page-break-inside:avoid;
        border:1px solid rgba(15,76,92,.18);
        border-radius:12px;
        overflow:hidden;
      }
      th,td{
        background:#fff !important;
        border-color:rgba(15,76,92,.18);
        padding:10px 12px;
      }
      .summary-row td{
        background:linear-gradient(135deg,rgba(44,140,108,.88),rgba(24,98,80,.82)) !important;
        color:#fff !important;
      }
      .opt-row:not(.opt-row--active){display:none !important}
      .include-toggle,
      .tag-included{display:none !important}
      #optionalTable.optional-empty{display:none !important}
    }
    @media(max-width:680px){
      header{flex-direction:column}
      .hero{width:100%}
      .controls input[type=number]{width:100%}
      .toolbar{align-items:stretch}
      .btn{width:100%;justify-content:center}
    }
    /* Login screen styles */
    .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--soft);padding:24px}
    .login-box{background:#fff;border-radius:20px;border:1px solid var(--line);box-shadow:0 30px 60px rgba(9,46,57,.08);padding:40px;max-width:400px;width:100%}
    .login-box h2{margin:0 0 8px;font:700 24px/1.25 Montserrat;color:var(--petrol-dark)}
    .login-box p{margin:0 0 24px;font-size:14px;color:var(--muted)}
    .login-form{display:flex;flex-direction:column;gap:16px}
    .login-form input{width:100%;padding:12px 14px;font:600 15px/1.1 Inter;border-radius:12px;border:1.5px solid var(--line);background:#fff;box-shadow:inset 0 1px 2px rgba(15,76,92,.05)}
    .login-form input:focus{outline:none;border-color:var(--petrol)}
    .login-error{display:none;padding:12px;background:#fff5f5;border:1px solid #d33f3f;border-radius:8px;color:#d33f3f;font-size:13px;margin-top:-8px}
    .login-error.show{display:block}
    .main-content{display:none}
    .main-content.authenticated{display:block}
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2>Secure Access</h2>
      <p>Please log in to access the pricing matrix.</p>
      <form class="login-form" id="loginForm">
        <input type="text" id="username" placeholder="Username" required autocomplete="username">
        <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
        <button type="submit" class="btn" style="width:100%">Log in</button>
        <div class="login-error" id="loginError">Incorrect username or password</div>
      </form>
    </div>
  </div>

  <!-- Main Content (hidden until authenticated) -->
  <div class="main-content" id="mainContent">
  <div class="page">
    <header>
      <img src="LOGO/OXO_CORPORATE_REPORTING_BLACK.png" alt="OXO Corporate Reporting">
      <div class="hero">
        <h1>Reporting Pricing Matrix</h1>
        <p>Build accurate estimates by adjusting pages and toggling optional services.</p>
      </div>
      <button class="btn" id="logoutBtn" style="margin-left:auto;align-self:flex-start;" title="Log out">Logout</button>
    </header>

    <div class="workspace">
      <div class="toolbar no-print">
        <div class="controls" id="pagesControl">
          <label for="pages">Number of pages</label>
          <input id="pages" type="number" min="0" step="1" value="" placeholder="Enter number" aria-label="Number of pages" required>
          <div class="hint">Enter total number of pages</div>
          <div class="hint required hidden" id="pagesHint">Required field</div>
        </div>
        <div class="controls">
          <label for="currencySelect">Currency</label>
          <select id="currencySelect" aria-label="Select currency">
            <option value="USD">USD</option>
            <option value="AED" selected>AED</option>
          </select>
        </div>
        <button class="btn" id="exportBtn" title="Export as PDF">Download PDF</button>
      </div>

      <div class="totals-grid">
        <div class="card">
          <div class="card-heading">Base package (1 → 6)</div>
          <strong id="totalBase">AED 0</strong>
          <small>Workshop, concept, layouts EN/AR, financial section, project management</small>
        </div>
        <div class="card">
          <div class="card-heading">Optional services</div>
          <strong id="totalOptions">AED 0</strong>
          <small>Interactive PDF, flipbook, microsite</small>
        </div>
        <div class="card grand">
          <div class="card-heading">Estimated project total</div>
          <strong id="totalGrand">AED 0</strong>
          <small>Updated in real time according to your selections</small>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40%">Section</th>
            <th class="center" style="width:12%">Include</th>
            <th class="right" style="width:12%">Quantity</th>
            <th class="right" style="width:12%">Pages</th>
            <th class="right" style="width:12%">Amount</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <table id="optionalTable" style="margin-top:28px">
        <thead>
          <tr>
            <th>Optional services</th>
            <th class="center">Include</th>
            <th class="right">Quantity</th>
            <th class="right">Amount</th>
          </tr>
        </thead>
        <tbody id="rowsOptional"></tbody>
      </table>
    </div>
  </div>

  <!-- Authentication Script (must run first) -->
  <script>
    (function() {
      // Attendre que le DOM soit chargé
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAuth);
      } else {
        initAuth();
      }

      function initAuth() {
        const AUTH_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/1w9ni9chAIuGjorkZzLlYiqcy9hHl_cmUDDSiQPGiAx8/gviz/tq?tqx=out:csv&gid=659672234';
        const AUTH_STORAGE_KEY = 'quote_pages_auth';
        const AUTH_SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 heures

        const loginScreen = document.getElementById('loginScreen');
        const mainContent = document.getElementById('mainContent');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        if (!loginScreen || !mainContent || !loginForm) {
          console.error('Auth elements not found!');
          return;
        }

        // Vérifier si l'utilisateur est déjà authentifié
        function checkAuth() {
          const authData = localStorage.getItem(AUTH_STORAGE_KEY);
          if (!authData) return false;

          try {
            const { username, timestamp } = JSON.parse(authData);
            const now = Date.now();
            
            // Vérifier si la session est expirée (24h)
            if (now - timestamp > AUTH_SESSION_DURATION) {
              localStorage.removeItem(AUTH_STORAGE_KEY);
              return false;
            }
            
            return username;
          } catch (e) {
            localStorage.removeItem(AUTH_STORAGE_KEY);
            return false;
          }
        }

        // Charger la liste des utilisateurs autorisés depuis le Google Sheet
        async function loadAuthorizedUsers() {
          try {
            const res = await fetch(AUTH_SHEET_CSV, { cache: 'no-store' });
            if (!res.ok) throw new Error('Failed to load users');
            const csv = await res.text();
            const lines = csv.trim().split(/\r?\n/);
            
            // Ignorer la première ligne (en-têtes)
            lines.shift();
            
            const users = new Map();
            lines.forEach(line => {
              const [user, password] = line.split(',').map(cell => 
                cell.replace(/^"|"$/g, '').trim()
              );
              if (user && password) {
                users.set(user.toLowerCase(), password);
              }
            });
            
            return users;
          } catch (err) {
            console.error('Error loading authorized users:', err);
            return new Map();
          }
        }

        // Authentifier l'utilisateur
        async function authenticate(username, password) {
          const authorizedUsers = await loadAuthorizedUsers();
          const userKey = username.toLowerCase();
          
          if (authorizedUsers.has(userKey) && authorizedUsers.get(userKey) === password) {
            // Stocker l'authentification
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({
              username: userKey,
              timestamp: Date.now()
            }));
            return true;
          }
          return false;
        }

        // Afficher le contenu principal
        function showMainContent() {
          loginScreen.style.display = 'none';
          mainContent.classList.add('authenticated');
          // Initialiser l'application une fois authentifié
          if (typeof window.initApp === 'function') {
            window.initApp();
          }
        }

        // Afficher l'écran de login
        function showLoginScreen() {
          loginScreen.style.display = 'flex';
          mainContent.classList.remove('authenticated');
          localStorage.removeItem(AUTH_STORAGE_KEY);
        }

        // Gérer le formulaire de login
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          loginError.classList.remove('show');
          
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            loginError.classList.add('show');
            return;
          }
          
          const isValid = await authenticate(username, password);
          
          if (isValid) {
            showMainContent();
          } else {
            loginError.classList.add('show');
            document.getElementById('password').value = '';
          }
        });

        // Exposer checkAuth globalement pour initApp
        window.checkAuth = checkAuth;

        // Vérifier l'authentification au chargement
        const authenticatedUser = checkAuth();
        console.log('Auth check result:', authenticatedUser);
        
        if (authenticatedUser) {
          console.log('User authenticated, showing main content');
          showMainContent();
        } else {
          console.log('User not authenticated, showing login screen');
          showLoginScreen();
        }

        // Bouton de déconnexion
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
              showLoginScreen();
            }
          });
        }
      }
    })();
  </script>

  <!-- Main Application Script (only runs if authenticated) -->
  <script>
    function initApp() {
    // Structure pour stocker les prix par tranche (tier1: 1-80, tier2: 81-200, tier3: >200)
    // Tous les prix seront chargés dynamiquement depuis le Google Sheet - aucune valeur codée en dur
    const PRICES = {
      workshop_fixed: {},
      design_fixed: {},
      layout_en_per_page: {},
      financial_en_per_page: {},
      layout_ar_per_page: {},
      pm_percentage: {},
      interactive_pdf_per_page: {},
      flipbook_per_page: {},
      microsite_fixed: {}
    };

    // Fonction pour déterminer la tranche selon le nombre de pages
    function getTier(pages) {
      if (pages <= 80) return 'tier1';
      if (pages <= 200) return 'tier2';
      return 'tier3';
    }

    // Fonction pour obtenir le prix selon la tranche
    function getPrice(priceObj, pages) {
      if (!priceObj) return 0;
      if (priceObj.fixed !== undefined) return priceObj.fixed;
      const tier = getTier(pages);
      return priceObj[tier] || 0;
    }

    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/1w9ni9chAIuGjorkZzLlYiqcy9hHl_cmUDDSiQPGiAx8/gviz/tq?tqx=out:csv&gid=441790827';
    // Onglet "Devises" pour les taux de change - GID à remplacer par celui de l'onglet "Devises"
    const CURRENCY_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/1w9ni9chAIuGjorkZzLlYiqcy9hHl_cmUDDSiQPGiAx8/gviz/tq?tqx=out:csv&gid=1246682262';

    let currentCurrency = 'AED';
    let exchangeRates = { USD: 1, AED: 1 }; // Taux par défaut = 1 si non trouvé dans le sheet
    let minimums = {}; // Minimums par service (ex: { 'design_per_page': 1800 })

    const fmt = (n, currency = currentCurrency) => {
      return new Intl.NumberFormat('en-US', {style: 'currency', currency: currency, maximumFractionDigits: 0}).format(n);
    };

    const convertAmount = (amountUSD) => {
      const rate = exchangeRates[currentCurrency] || 1;
      if (currentCurrency !== 'USD') {
        console.log(`Converting ${amountUSD} USD to ${currentCurrency} (rate: ${rate}) = ${amountUSD * rate}`);
      }
      return amountUSD * rate;
    };

    const pagesEl = document.getElementById('pages');
    const exportBtn = document.getElementById('exportBtn');
    const controlsBox = document.getElementById('pagesControl');
    const pagesHint = document.getElementById('pagesHint');
    const currencySelect = document.getElementById('currencySelect');
    const rowsEl = document.getElementById('rows');
    const rowsOptEl = document.getElementById('rowsOptional');
    const optionalTable = document.getElementById('optionalTable');
    const totalBaseEl = document.getElementById('totalBase');
    const totalOptionsEl = document.getElementById('totalOptions');
    const totalGrandEl = document.getElementById('totalGrand');

    const toggles = {
      opt7: false,
      opt8: false,
      opt9: false
    };
    let includeArabic = true;
    let includeDesign = true; // Section 2 - Report Creative Concept & Design
    // Pages spécifiques pour les sections 3 et 4
    let pagesSection3 = 0;
    let pagesSection4 = 0;

    const BASE_SERVICES = [
      {
        id: 'base1',
        title: '1. Corporate Report Project Workshop (3 hour session)',
        key: 'workshop_fixed',
        type: 'fixed',
        description: 'Report project structuring & alignment, brand content strategy benchmarking & deployment, OXO process training (TOM collaborative platform).',
        quantity: () => '—',
        hasSpecificPages: false
      },
      {
        id: 'base2',
        title: '2. Report Creative Concept & Design',
        key: 'design_fixed',
        type: 'fixed',
        description: 'Design proposals ×2, moodboards, visual concept mock-ups, icons, tables, diagrams & graphs.',
        hasSpecificPages: false
      },
      {
        id: 'base3',
        title: '3. Integrated Report Layout – <span class="highlight-magenta">English</span>',
        key: 'layout_en_per_page',
        type: 'per_page',
        description: 'HD web PDF with hyperlinks. Layout of integrated report. Up to V3 included.',
        hasSpecificPages: true
      },
      {
        id: 'base4',
        title: '4. Integrated Report Financial section – <span class="highlight-magenta">English</span>',
        key: 'financial_en_per_page',
        type: 'per_page',
        description: 'Financial section layout in English. Up to V3 included.',
        hasSpecificPages: true
      },
      {
        id: 'base5',
        title: '5. Integrated Report Layout – <span class="highlight-magenta">Arabic</span>',
        key: 'layout_ar_per_page',
        type: 'per_page',
        description: 'Arabic version – identical structure, HD web PDF with hyperlinks. Up to V3 included.',
        hasSpecificPages: false
      },
      {
        id: 'base6',
        title: '6. Project Management',
        key: 'pm_percentage',
        type: 'percentage',
        description: 'Dedicated project manager. Technical coordination & advisory.',
        hasSpecificPages: false
      }
    ];

    const OPTIONAL_SERVICES = [
      {
        id: 'opt7',
        title: '7. Native Interactive PDF (up to 8 animations)',
        key: 'interactive_pdf_per_page',
        type: 'optional_per_page',
        description: 'Pre-defined animations per design proposal; offline interactivity.',
        links: [
          ['CIEL Integrated Report 2024', 'https://www.cielgroup.com/sites/default/files/2024-11/CIEL_%20Annual%20Integrated%20Report%20_2024.pdf'],
          ['ENL Integrated Report 2024', 'https://www.enl.mu/media/u0nlqn3i/enl-integrated-report-2024.pdf']
        ]
      },
      {
        id: 'opt8',
        title: '8. Interactive Flipbook (up to 10 animations)',
        key: 'flipbook_per_page',
        type: 'optional_per_page',
        description: 'Interactive flipbook mirroring the report navigation.',
        links: [
          ['Publuu Flipbook #4712', 'https://publuu.com/flip-book/4712/9016/page/1?cover'],
          ['Publuu Flipbook #4002', 'https://publuu.com/flip-book/4002/120275/page/1?cover']
        ]
      },
      {
        id: 'opt9',
        title: '9. Microsite (one-page website)',
        key: 'microsite_fixed',
        type: 'optional_fixed',
        description: 'One-page microsite hosting highlight modules and leadership messages.',
        links: [
          ['Velogic 2023', 'https://integratedreport.velogic.net/2023/'],
          ['Velogic 2024', 'https://integratedreport.velogic.net/2024/'],
          ['Velogic 2025', 'https://integratedreport.velogic.net/2025/']
        ],
        quantity: () => '1 project'
      }
    ];

    const normalizeLabel = (label = '') => label
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '');

    function calculateAmount(priceObj, type, pages, totalPagesForTier = null) {
      if (!priceObj) return 0;
      // Utiliser totalPagesForTier pour déterminer la tranche si fourni, sinon utiliser pages
      const tierPages = totalPagesForTier !== null ? totalPagesForTier : pages;
      const price = getPrice(priceObj, tierPages);
      if (typeof price !== 'number' || Number.isNaN(price)) return 0;
      return type.includes('fixed') ? price : price * pages;
    }

    function formatQuantity(service, pages) {
      // Ne pas afficher de quantité pour Project Management (percentage)
      if (service.type === 'percentage') {
        return '—';
      }
      if (typeof service.quantity === 'function') {
        return service.quantity(pages);
      }
      if (service.type.includes('per_page')) {
        if (pages <= 0) return '—';
        const unit = pages === 1 ? 'page' : 'pages';
        return `${pages} ${unit}`;
      }
      if (service.type.includes('fixed')) {
        if (pages <= 0) return '—';
        return '1 project';
      }
      return '—';
    }

    function linkList(items) {
      if (!items || !items.length) return '';
      return `<ul class="link-list">${items.map(([label, url]) => `<li><a href="${url}" target="_blank" rel="noopener">${label}</a></li>`).join('')}</ul>`;
    }

    function row(title, desc, includeHtml, qty, pagesInput, amount, serviceId, invalid = false) {
      const invalidClass = invalid ? ' row-invalid' : '';
      return `<tr class="${invalidClass}">
        <td>
          <div class="section-label">${title}</div>
          ${desc ? `<div class="section-note">${desc}</div>` : ''}
        </td>
        <td class="include-cell">${includeHtml}</td>
        <td class="right">${qty}</td>
        <td class="right">${pagesInput || '—'}</td>
        <td class="right mono">${fmt(amount)}</td>
      </tr>`;
    }

    function optRow(service, detail, qty, amount, include) {
      return `<tr class="opt-row${include ? ' opt-row--active' : ''}">
        <td>
          <div class="section-label">${service.title} <span class="opt-flag">OPTIONAL</span></div>
          ${detail ? `<div class="section-note">${detail}</div>` : ''}
        </td>
        <td class="include-cell">
          <label class="include-toggle">
            <input type="checkbox" id="${service.id}" ${include ? 'checked' : ''}>
            <span>Include</span>
          </label>
        </td>
        <td class="right opt-quantity">${qty}</td>
        <td class="right mono">${fmt(amount)}</td>
      </tr>`;
    }

    function renderBaseRows(pages, optionalTotals = {}) {
      let subtotal = 0;
      const amountByIdUSD = {};
      // Validation : pagesSection3 + pagesSection4 doit égaler pages
      const pagesTotal = pagesSection3 + pagesSection4;
      const isValidPages = pagesTotal === pages && pages > 0;
      
      const html = BASE_SERVICES.map(service => {
        const unit = PRICES[service.key];
        const isOptionalArabic = service.id === 'base5';
        const isOptionalDesign = service.id === 'base2';
        const isIncluded = isOptionalArabic ? includeArabic : (isOptionalDesign ? includeDesign : true);
        let includeMarkup = '<span class="tag-included">Included</span>';
        if (isOptionalArabic) {
          includeMarkup = `<label class="include-toggle-arabic"><input type="checkbox" id="includeArabic" ${includeArabic ? 'checked' : ''}><span>Include</span></label>`;
        } else if (isOptionalDesign) {
          includeMarkup = `<label class="include-toggle-arabic"><input type="checkbox" id="includeDesign" ${includeDesign ? 'checked' : ''}><span>Include</span></label>`;
        }
        
        let qtyDisplay = '—';
        let pagesInput = '—';
        let amountUSD = 0;
        let description = service.description;
        
        // Gérer les pages spécifiques pour les sections 3 et 4
        let pagesToUse = pages;
        if (service.hasSpecificPages) {
          const invalidStyle = !isValidPages && pages > 0 ? 'border-color:#d33f3f !important;color:#d33f3f;font-weight:700;' : '';
          if (service.id === 'base3') {
            pagesToUse = pagesSection3;
            pagesInput = `<input type="number" id="pagesSection3" min="0" step="1" value="${pagesSection3}" style="width:80px;padding:6px;border-radius:6px;border:1.5px solid var(--line);text-align:right;${invalidStyle}" />`;
          } else if (service.id === 'base4') {
            pagesToUse = pagesSection4;
            pagesInput = `<input type="number" id="pagesSection4" min="0" step="1" value="${pagesSection4}" style="width:80px;padding:6px;border-radius:6px;border:1.5px solid var(--line);text-align:right;${invalidStyle}" />`;
          }
        }

        if (isIncluded) {
          if (service.id === 'base6') {
            // Project Management = pourcentage depuis la matrice de base2, base3, base4 + optionnels
            // Utiliser le nombre total de pages pour déterminer la tranche
            const eligibleTotalUSD =
              (amountByIdUSD['base2'] || 0) +
              (amountByIdUSD['base3'] || 0) +
              (amountByIdUSD['base4'] || 0) +
              (optionalTotals['opt7'] || 0) +
              (optionalTotals['opt8'] || 0) +
              (optionalTotals['opt9'] || 0);
            const pmPercentage = getPrice(unit, pages); // Utiliser pages (total) pour la tranche
            amountUSD = eligibleTotalUSD * pmPercentage;
            // FORCER l'affichage à "—" pour ne pas afficher le pourcentage
            qtyDisplay = '—';
          } else if (service.id === 'base2') {
            // Section 2 (Creative Concept) : prix fixe (flat rate) depuis la matrice selon la tranche
            // C'est un prix fixe, pas un prix par page - unité = 1, on utilise juste le nombre total de pages pour déterminer la tranche
            // Ne PAS multiplier par pages, c'est un prix fixe
            amountUSD = getPrice(unit, pages); // Prix fixe selon la tranche (1-80, 81-200, >200) - unité = 1
            if (pages <= 0) {
              amountUSD = 0;
            }
            qtyDisplay = '1'; // Unité = 1 pour un prix fixe
          } else {
            // Pour les services per_page, utiliser pagesToUse pour le calcul mais pages (total) pour la tranche
            amountUSD = calculateAmount(unit, service.type, pagesToUse, pages);
            if (pagesToUse <= 0 && service.type.includes('fixed')) {
              amountUSD = 0;
            }
            qtyDisplay = formatQuantity(service, pagesToUse);
          }
        }
        
        amountByIdUSD[service.id] = amountUSD;
        const amountDisplay = convertAmount(amountUSD);
        subtotal += amountDisplay;
        // Marquer les sections 3 et 4 comme invalides si la validation échoue
        const isInvalid = (service.id === 'base3' || service.id === 'base4') && !isValidPages && pages > 0;
        return row(service.title, description, includeMarkup, qtyDisplay, pagesInput, amountDisplay, service.id, isInvalid);
      }).join('');

      const subtotalRow = `<tr class="summary-row"><td colspan="4" class="right">TOTAL SECTIONS 1 TO 6</td><td class="right mono">${fmt(subtotal)}</td></tr>`;
      return { html: html + subtotalRow, subtotal, isValidPages };
    }

    function renderOptionalRows(pages) {
      let total = 0;
      let hasActive = false;
      const totalsById = {};
      const html = OPTIONAL_SERVICES.map(service => {
        const unit = PRICES[service.key];
        const quantityRaw = formatQuantity(service, pages);
        const include = Boolean(toggles[service.id]);
        const qty = include ? quantityRaw : '—';
        // Utiliser pages pour le calcul ET pour déterminer la tranche
        let amountUSD = include ? calculateAmount(unit, service.type, pages, pages) : 0;
        const amountDisplay = convertAmount(amountUSD);
        totalsById[service.id] = amountUSD;
        if (include) {
          total += amountDisplay;
          hasActive = true;
        }
        const detail = service.description + (service.links ? linkList(service.links) : '');
        return optRow(service, detail, qty, amountDisplay, include);
      }).join('');
      return { html, total, hasActive, totalsById };
    }

    function attachBaseHandlers() {
      const checkboxArabic = document.getElementById('includeArabic');
      if (checkboxArabic) {
        checkboxArabic.addEventListener('change', (event) => {
          includeArabic = event.target.checked;
          render();
        });
      }
      
      const checkboxDesign = document.getElementById('includeDesign');
      if (checkboxDesign) {
        checkboxDesign.addEventListener('change', (event) => {
          includeDesign = event.target.checked;
          render();
        });
      }
      
      // Handlers pour les pages spécifiques des sections 3 et 4
      const pages3Input = document.getElementById('pagesSection3');
      if (pages3Input) {
        pages3Input.addEventListener('input', (event) => {
          pagesSection3 = Math.max(0, Number(event.target.value) || 0);
          render();
        });
      }
      
      const pages4Input = document.getElementById('pagesSection4');
      if (pages4Input) {
        pages4Input.addEventListener('input', (event) => {
          pagesSection4 = Math.max(0, Number(event.target.value) || 0);
          render();
        });
      }
    }

    function attachOptionHandlers() {
      OPTIONAL_SERVICES.forEach(service => {
        const checkbox = document.getElementById(service.id);
        if (checkbox) {
          checkbox.addEventListener('change', (event) => {
            toggles[service.id] = event.target.checked;
            render();
          });
        }
      });
    }

    function render() {
      const raw = (pagesEl.value || '').trim();
      const parsed = Number(raw);
      const missing = raw === '' || Number.isNaN(parsed) || parsed <= 0;
      const pages = missing ? 0 : Math.max(0, parsed);

      controlsBox.classList.toggle('is-missing', missing);
      pagesHint.classList.toggle('hidden', !missing);

      const optional = renderOptionalRows(pages);
      const base = renderBaseRows(pages, optional.totalsById);

      rowsEl.innerHTML = base.html;
      rowsOptEl.innerHTML = optional.html;
      optionalTable.classList.toggle('optional-empty', !optional.hasActive);

      totalBaseEl.textContent = fmt(base.subtotal);
      totalOptionsEl.textContent = fmt(optional.total);
      totalGrandEl.textContent = fmt(base.subtotal + optional.total);

      // Désactiver le bouton si pages manquantes OU validation des pages 3+4 échoue
      const pagesTotal = pagesSection3 + pagesSection4;
      const isValidPages = pagesTotal === pages && pages > 0;
      exportBtn.disabled = missing || !isValidPages;

      attachBaseHandlers();
      attachOptionHandlers();
    }

    ['input','change','keyup','blur','paste'].forEach(evt => pagesEl.addEventListener(evt, render));

    if (currencySelect) {
      currencySelect.addEventListener('change', (event) => {
        currentCurrency = event.target.value;
        render();
      });
    }

    exportBtn.addEventListener('click', () => {
      window.print();
    });

    render();

    // Fonction pour charger les taux de change depuis l'onglet "Devises"
    async function loadExchangeRates() {
      try {
        const res = await fetch(CURRENCY_SHEET_CSV, { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        const csv = await res.text();
        const lines = csv.trim().split(/\r?\n/);
        lines.shift();
        const rows = lines.map(line => line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(cell => cell.replace(/^\"|\"$/g, '').trim()))
          .filter(cols => cols.length >= 4);

        rows.forEach(([section, label, type, price]) => {
          // Gérer les nombres avec virgule (format européen) ou point (format US)
          // Ex: "3,61" ou "3.61" → 3.61
          let cleaned = (price || '').trim();
          // Remplacer la virgule par un point pour le parsing
          cleaned = cleaned.replace(/,/g, '.');
          // Garder seulement les chiffres, points et tirets
          cleaned = cleaned.replace(/[^\d.-]/g, '');
          const numeric = cleaned === '' ? NaN : Number(cleaned);
          const labelUpper = (label || '').toUpperCase().trim();
          
          // Détection du code devise dans le label (AED, EUR, etc.)
          const currencyCode = labelUpper.match(/\b(USD|AED|EUR|GBP|JPY|CHF|CAD|AUD)\b/);
          if (currencyCode && !Number.isNaN(numeric) && numeric > 0) {
            exchangeRates[currencyCode[1]] = numeric;
            console.log(`✓ Exchange rate loaded from "Devises" tab: ${currencyCode[1]} = ${numeric}`);
          } else if (labelUpper.trim().match(/^(USD|AED|EUR|GBP|JPY|CHF|CAD|AUD)$/) && !Number.isNaN(numeric) && numeric > 0) {
            // Si le label est directement un code devise
            const code = labelUpper.trim();
            exchangeRates[code] = numeric;
            console.log(`✓ Exchange rate loaded (direct): ${code} = ${numeric}`);
          }
        });
      } catch (err) {
        console.warn('Unable to load exchange rates from "Devises" tab:', err);
      }
    }

    (async function loadPrices() {
      try {
        const res = await fetch(SHEET_CSV, { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        const csv = await res.text();
        const lines = csv.trim().split(/\r?\n/);
        lines.shift(); // Skip header
        const rows = lines.map(line => line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(cell => cell.replace(/^\"|\"$/g, '').trim()))
          .filter(cols => cols.length >= 4);

        const byLabel = new Map();
        rows.forEach(([section, label, type, priceUSD, tier1, tier2, tier3]) => {
          const slug = normalizeLabel(label);
          
          // Fonction helper pour parser un prix (peut être un nombre ou un pourcentage)
          function parsePrice(value) {
            if (!value) return NaN;
            let cleaned = value.trim();
            // Si c'est un pourcentage (contient %), convertir en décimal
            if (cleaned.includes('%')) {
              cleaned = cleaned.replace(/%/g, '').trim();
              cleaned = cleaned.replace(/,/g, '.');
              const num = Number(cleaned);
              return isNaN(num) ? NaN : num / 100; // Convertir 25% en 0.25
            }
            // Sinon, traiter comme un nombre
            cleaned = cleaned.replace(/,/g, '.');
            cleaned = cleaned.replace(/[^\d.-]/g, '');
            return cleaned === '' ? NaN : Number(cleaned);
          }

          // Charger les minimums depuis la section "MINIMUMS"
          const sectionUpper = (section || '').toUpperCase().trim();
          if (sectionUpper === 'MINIMUMS' || sectionUpper === 'MINIMUM') {
            const labelSlug = normalizeLabel(label);
            const minKeyMap = {
              [normalizeLabel('Report Creative Concept & Design')]: 'design_fixed'
            };
            const minKey = minKeyMap[labelSlug];
            const numeric = parsePrice(priceUSD);
            if (minKey && !Number.isNaN(numeric) && numeric > 0) {
              minimums[minKey] = numeric;
              console.log(`✓ Minimum loaded from Google Sheet: ${minKey} = ${numeric}`);
            }
          } else if (slug) {
            // Charger les prix par tranche
            const priceData = {};
            const tier1Price = parsePrice(tier1 || priceUSD);
            const tier2Price = parsePrice(tier2 || tier1 || priceUSD);
            const tier3Price = parsePrice(tier3 || tier2 || tier1 || priceUSD);
            
            if (type && type.toLowerCase().includes('fixed')) {
              // Pour les prix fixes, utiliser les tranches comme valeurs fixes
              if (!Number.isNaN(tier1Price)) priceData.tier1 = tier1Price;
              if (!Number.isNaN(tier2Price)) priceData.tier2 = tier2Price;
              if (!Number.isNaN(tier3Price)) priceData.tier3 = tier3Price;
              // Si une seule valeur, utiliser fixed
              if (tier1Price === tier2Price && tier2Price === tier3Price && !Number.isNaN(tier1Price)) {
                priceData.fixed = tier1Price;
              }
            } else {
              // Pour les prix par page ou pourcentages, utiliser les tranches
              if (!Number.isNaN(tier1Price)) priceData.tier1 = tier1Price;
              if (!Number.isNaN(tier2Price)) priceData.tier2 = tier2Price;
              if (!Number.isNaN(tier3Price)) priceData.tier3 = tier3Price;
            }
            
            if (Object.keys(priceData).length > 0) {
              byLabel.set(slug, { type, priceData });
            }
          }
        });

        const labelToKey = {
          [normalizeLabel('Corporate Report Project Workshop')]: 'workshop_fixed',
          [normalizeLabel('Report Creative Concept & Design')]: 'design_fixed',
          [normalizeLabel('Integrated Report Layout – English')]: 'layout_en_per_page',
          [normalizeLabel('Integrated Report Financial section – English')]: 'financial_en_per_page',
          [normalizeLabel('Integrated Report Layout – Arabic')]: 'layout_ar_per_page',
          [normalizeLabel('Project Management')]: 'pm_percentage',
          [normalizeLabel('Native Interactive PDF')]: 'interactive_pdf_per_page',
          [normalizeLabel('Interactive Flipbook')]: 'flipbook_per_page',
          [normalizeLabel('Microsite')]: 'microsite_fixed'
        };

        Object.entries(labelToKey).forEach(([slug, key]) => {
          const record = byLabel.get(slug);
          if (record && record.priceData) {
            PRICES[key] = record.priceData;
            console.log(`✓ Loaded ${key}:`, record.priceData);
          }
        });
        
        console.log('Prices loaded from Google Sheet with tiered pricing');
      } catch (err) {
        console.warn('Unable to load Google Sheet:', err);
      }
      
      // Charger les taux de change depuis l'onglet "Devises"
      await loadExchangeRates();
      
      console.log('Exchange rates loaded:', exchangeRates);
      if (!exchangeRates['AED'] || exchangeRates['AED'] === 1) {
        console.error('❌ AED exchange rate NOT FOUND in "Devises" tab!');
        console.error('Check that the "Devises" tab contains: Label=AED, Unit Price=taux');
        console.error('Current exchangeRates:', exchangeRates);
      } else {
        console.log('✓ AED rate loaded:', exchangeRates['AED']);
      }
      
      render();
    })();
    }

    // Exposer initApp globalement
    window.initApp = initApp;

    // Initialiser l'application seulement si authentifié au chargement
    // Attendre que checkAuth soit disponible (exposé par le script d'authentification)
    if (typeof window.checkAuth === 'function' && window.checkAuth()) {
      initApp();
    } else {
      console.log('App not initialized - user not authenticated');
    }
  </script>
  </div>
</body>
</html>
